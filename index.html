<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Smart AI Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    /* DARK THEME VARIABLES */
    --bg: #000000;
    --text: #ffffff;
    --muted: #a1a1aa;
    
    /* Dynamic Accent */
    --accent: #ffffff; 
    --accent-text: #000000;
    
    --card-bg: #121212;
    --input-bg: #1c1c1c;
    --btn-bg: #262626;
    --btn-text: #ffffff;
    
    --border: #333333;
    --shadow: 0 4px 12px rgba(0,0,0,0.5);
  }

  body[data-theme="light"]{
    --bg: #f2f2f7;
    --text: #000000;
    --muted: #666666;
    
    --accent: #000000;
    --accent-text: #ffffff;

    --card-bg: #ffffff;
    --input-bg: #f2f2f7;
    --btn-bg: #e5e5ea;
    --btn-text: #000000;
    
    --border: #d1d1d6;
    --shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  *{box-sizing:border-box;margin:0;padding:0; -webkit-tap-highlight-color: transparent;}
  
  html,body{
    min-height:100%;
    font-family:"Poppins",system-ui,-apple-system,sans-serif;
  }
  
  html { overflow-y: scroll; } 
  
  body{
    background-color: var(--bg);
    color: var(--text);
    display: flex;
    justify-content: center;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .app{
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding-bottom: 50px;
  }

  /* HEADER */
  header{
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
  }
  .brand{ display: flex; flex-direction: column; justify-content: center; }
  h1{ font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; }
  .subtitle{ font-size: 0.85rem; color: var(--muted); margin-top: 2px; }
  
  .theme-block{ display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
  
  .pill, .dropdown-trigger {
    height: 32px;
    display: flex; align-items: center; justify-content: center;
    background: var(--btn-bg);
    color: var(--btn-text);
    border: 1px solid var(--border);
    padding: 0 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    cursor: pointer;
    font-weight: 500;
    transition: 0.2s;
    box-sizing: border-box;
  }

  /* CARDS */
  .card{
    background: var(--card-bg);
    border-radius: 24px;
    padding: 20px 18px 24px 18px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: background 0.3s ease;
  }
  .card-header{
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
  }
  .title-group { display: flex; flex-direction: column; }
  .card-title{ font-size: 1rem; font-weight: 600; }
  .card-sub{ font-size: 0.75rem; color: var(--muted); margin-top: 2px; line-height: 1.3; }

  /* SEARCH BAR */
  .search-box {
    position: relative; margin-bottom: 15px;
  }
  .search-input {
    width: 100%; background: var(--input-bg); border: 1px solid var(--border);
    padding: 12px 12px 12px 40px; border-radius: 14px; color: var(--text);
    font-size: 0.9rem; outline: none; transition: 0.2s;
  }
  .search-input:focus { border-color: var(--accent); }
  .search-icon {
    position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
    width: 16px; height: 16px; border: 2px solid var(--muted); border-radius: 50%;
  }
  .search-icon::after {
    content: ''; position: absolute; right: -4px; bottom: -4px; width: 6px; height: 2px;
    background: var(--muted); transform: rotate(45deg);
  }

  /* INPUTS */
  input, textarea {
    width: 100%;
    background: var(--input-bg);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 12px 16px;
    border-radius: 14px;
    font-size: 0.95rem;
    outline: none;
    appearance: none; 
    transition: border 0.2s;
  }
  input:focus, textarea:focus { border-color: var(--accent); }

  /* DROPDOWNS */
  select { display: none; } 
  .custom-dropdown { position: relative; width: 100%; font-size: 0.9rem; user-select: none; }
  .dropdown-trigger {
    justify-content: space-between; width: 100%; padding-right: 30px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 60px;
  }
  .theme-block .custom-dropdown { width: auto; min-width: 90px; }
  .dropdown-trigger::after {
    content: ''; position: absolute; right: 12px; top: 50%; width: 8px; height: 8px;
    border-right: 2px solid var(--muted); border-bottom: 2px solid var(--muted);
    transform: translateY(-70%) rotate(45deg); transition: 0.2s;
  }
  .custom-dropdown.active .dropdown-trigger::after { transform: translateY(-30%) rotate(-135deg); border-color: var(--accent); }
  .dropdown-menu {
    position: absolute; top: calc(100% + 6px); left: 0; width: 100%; min-width: 100px;
    background: var(--card-bg); border: 1px solid var(--border); border-radius: 14px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 100; display: none;
    max-height: 250px; overflow-y: auto; flex-direction: column; padding: 6px;
    animation: fadeIn 0.15s ease-out;
  }
  .theme-block .dropdown-menu { left: auto; right: 0; }
  .custom-dropdown.active .dropdown-menu { display: flex; }
  .dropdown-item {
    padding: 10px 12px; cursor: pointer; border-radius: 8px; color: var(--text);
    transition: background 0.1s; display: flex; align-items: center; justify-content: space-between;
  }
  .dropdown-item:hover { background: var(--btn-bg); }
  .dropdown-item.selected { color: var(--accent); font-weight: 600; background: rgba(128,128,128,0.1); }
  
  /* CALCULATOR UI */
  .sc-switch{
    position: relative; width: 60px; height: 28px; background: var(--input-bg);
    border-radius: 20px; cursor: pointer; border: 1px solid var(--border);
    display: flex; align-items: center; padding: 2px;
  }
  .sc-knob{
    width: 22px; height: 22px; background: var(--text); border-radius: 50%;
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .sc-switch.on .sc-knob{ transform: translateX(30px); background: var(--accent); }
  .sc-label{ position: absolute; right: 8px; font-size: 0.65rem; font-weight: 600; color: var(--muted); pointer-events: none; }

  .calc-display{
    background: var(--input-bg); border-radius: 16px; padding: 16px; margin-bottom: 16px; 
    text-align: right; position: relative; 
    min-height: 120px; display: flex; flex-direction: column; justify-content: flex-end;
  }
  
  /* HISTORY */
  .history-label {
    position: absolute; top: 12px; left: 16px;
    font-size: 0.65rem; font-weight: 700; color: var(--accent); 
    letter-spacing: 1px; text-transform: uppercase; display: none;
  }
  .calc-history {
    position: absolute; top: 28px; left: 16px; width: 60%;
    max-height: 70px; overflow-y: auto;
    display: flex; flex-direction: column; align-items: flex-start; gap: 4px;
    pointer-events: auto; z-index: 10;
    opacity: 0; transition: opacity 0.2s;
  }
  .calc-history.show { opacity: 1; }
  .hist-item { font-size: 0.8rem; color: var(--muted); cursor: pointer; white-space: nowrap; }
  .hist-item:hover { color: var(--accent); }

  .calc-expression{ font-size: 0.9rem; color: var(--muted); min-height: 20px; }
  .calc-result{ font-size: 2.2rem; font-weight: 500; color: var(--text); }
  .calc-grid{ display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }

  .btn{
    background: var(--btn-bg); color: var(--btn-text); border: none; border-radius: 50px;
    padding: 12px 0; font-size: 1.1rem; font-weight: 500; cursor: pointer;
    transition: transform 0.1s, filter 0.2s; display: flex; align-items: center; justify-content: center;
  }
  .btn:active{ transform: scale(0.96); }
  .btn-accent{ background: var(--accent); color: var(--accent-text); padding: 8px 0; font-size: 1rem; }
  .small{ font-size: 0.9rem; padding: 10px; }
  .btn.active-mode { border: 1px solid var(--accent); color: var(--accent); }
  
  .btn-action { margin-top: 15px; margin-bottom: 5px; width: 100%; }

  .row{ display: flex; gap: 10px; align-items: center; width: 100%; }
  .flex-1{ flex: 1; min-width: 0; }
  .field{ display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
  .mini{ font-size: 0.75rem; color: var(--muted); padding-left: 4px;}
  .result-text{ margin-top: 8px; font-size: 0.95rem; font-weight: 500; line-height: 1.5; }
  .muted-text { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }
  
  /* CHIPS & CATEGORIES */
  .category-label {
    font-size: 0.75rem; font-weight: 600; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.5px; margin: 20px 0 10px 4px;
  }
  .chips{ display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 5px; }
  .chip-btn{
    background: var(--btn-bg); color: var(--btn-text); border: 1px solid var(--border);
    padding: 8px 14px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.2s;
  }
  .chip-btn.active{ background: var(--accent); color: var(--accent-text); border-color: var(--accent); font-weight: 600; }
  .chip-btn.hidden { display: none; }

  .panel{ display: none; animation: fadeIn 0.3s ease; }
  .panel.active{ display: block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(5px);} to{opacity:1;transform:translateY(0);} }
  .divider{ height: 1px; background: var(--border); margin: 16px 0; }

  /* HEALTH & TEXT STATS GRID */
  .health-stats, .text-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
  .stat-box { 
    background: var(--input-bg); border-radius: 12px; padding: 12px; 
    display: flex; flex-direction: column; align-items: center; text-align: center; 
    border: 1px solid var(--border); position: relative;
  }
  .stat-val { font-size: 1.1rem; font-weight: 600; color: var(--accent); margin-bottom: 4px; }
  .stat-lbl { font-size: 0.7rem; color: var(--muted); }
  
  .info-icon {
    position: absolute; top: 6px; right: 8px;
    width: 14px; height: 14px; border-radius: 50%; border: 1px solid var(--muted);
    color: var(--muted); font-size: 9px; line-height: 13px; font-weight: bold;
    cursor: pointer; opacity: 0.7;
  }
  .info-icon:hover { opacity: 1; border-color: var(--accent); color: var(--accent); }

  /* QR Area */
  .qr-container {
    margin-top: 0; display: none; flex-direction: column; align-items: center; justify-content: center; padding-top: 15px;
  }
  .qr-container.show { display: flex; }
  .qr-img { border-radius: 8px; border: 4px solid #fff; max-width: 180px; }
  .loading-txt { font-size: 0.8rem; color: var(--accent); margin-bottom: 10px; }
  .link-btn { text-decoration: none; font-size: 0.75rem; color: var(--muted); border-bottom: 1px dotted var(--muted); cursor: pointer; }

  footer{ text-align: center; padding: 20px 0; color: var(--muted); font-size: 0.8rem; border-top: 1px solid var(--border); margin-top: 20px; }
  .heart { display: inline-block; color: var(--accent); animation: heartbeat 1.5s infinite; }
  @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.3); } 30% { transform: scale(1); } 45% { transform: scale(1.3); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
</style>
</head>
<body data-theme="dark">

<div class="app">
  
  <header>
    <div class="brand">
      <h1>Smart AI Calculator</h1>
      <div class="subtitle">Minimal, fast & versatile.</div>
    </div>
    
    <div class="theme-block">
      <button id="toggle-theme" class="pill">Dark / Light</button>
      <select id="theme-color">
        <option value="mono" selected>Default</option>
        <option value="orange">Orange</option>
        <option value="blue">Blue</option>
        <option value="green">Green</option>
        <option value="purple">Purple</option>
      </select>
    </div>
  </header>

  <main style="display:flex; flex-direction:column; gap:20px;">
    
    <section class="card">
      <div class="card-header">
        <div class="title-group">
          <div class="card-title">Calculator</div>
          <div class="card-sub">Scientific Mode & Smart History.</div>
        </div>
        <div id="sc-switch" class="sc-switch">
          <span class="sc-label">SCI</span>
          <div class="sc-knob"></div>
        </div>
      </div>

      <div class="calc-display">
        <div id="hist-lbl" class="history-label">History</div>
        <div id="calc-history" class="calc-history"></div>
        <div id="calc-expression" class="calc-expression"></div>
        <div id="calc-result" class="calc-result">0</div>
      </div>
      <div id="calc-grid" class="calc-grid"></div>
      <div class="calc-grid" style="margin-top:10px">
        <button id="calc-clear" class="btn small">AC</button>
        <button id="calc-back" class="btn small">⌫</button>
        <button id="calc-copy" class="btn small">Copy</button>
        <button id="calc-equals" class="btn btn-accent">=</button>
      </div>
      <div id="sci-keys" class="calc-grid" style="margin-top:10px; display:none;">
        <button class="btn small" id="deg-toggle" style="font-size:0.8rem">DEG</button>
        <button class="btn small" data-fn="sin">sin</button>
        <button class="btn small" data-fn="cos">cos</button>
        <button class="btn small" data-fn="tan">tan</button>
        <button class="btn small" data-fn="sqrt">√</button>
        <button class="btn small" data-fn="ln">ln</button>
        <button class="btn small" data-fn="log">log</button>
        <button class="btn small" data-fn="pow">xʸ</button>
        <button class="btn small" data-fn="pi">π</button>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
         <div class="title-group">
          <div class="card-title">Age Calculator</div>
          <div class="card-sub">Calculate your exact age from DOB.</div>
        </div>
      </div>
      <div class="field">
        <label class="mini">Date of birth</label>
        <input type="date" id="dob-input">
      </div>
      <button id="age-btn" class="btn btn-accent btn-action">Calculate Age</button>
      <div id="age-result" class="result-text"></div>
    </section>

    <section class="card">
      <div class="card-header">
         <div class="title-group">
          <div class="card-title">Currency Converter</div>
          <div class="card-sub">Real-time exchange rates.</div>
        </div>
      </div>
      <div class="row">
        <div class="field flex-1"><label class="mini">Amount</label><input id="cur-amt" type="number" placeholder="1"></div>
        <div class="field flex-1"><label class="mini">From</label>
          <select id="cur-from">
            <option value="USD" selected>USD</option><option value="EUR">EUR</option><option value="INR">INR</option>
            <option value="GBP">GBP</option><option value="JPY">JPY</option><option value="AUD">AUD</option>
            <option value="CAD">CAD</option><option value="CNY">CNY</option><option value="CHF">CHF</option><option value="NZD">NZD</option>
          </select>
        </div>
        <div class="field flex-1"><label class="mini">To</label>
          <select id="cur-to">
            <option value="INR" selected>INR</option><option value="USD">USD</option><option value="EUR">EUR</option>
            <option value="GBP">GBP</option><option value="JPY">JPY</option><option value="AUD">AUD</option>
            <option value="CAD">CAD</option><option value="CNY">CNY</option><option value="CHF">CHF</option><option value="NZD">NZD</option>
          </select>
        </div>
      </div>
      <div class="row">
        <button id="cur-btn" class="btn btn-accent flex-1 btn-action">Convert</button>
        <button id="cur-swap" class="btn small" style="width:50px; margin-top:10px;">⇄</button>
      </div>
      <div id="cur-res" class="result-text"></div>
      <div id="cur-source" class="muted-text" style="display:none;">
        <span id="cur-date"></span> | <a href="https://www.frankfurter.app" target="_blank" class="link-btn">Source: Frankfurter API</a>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div class="title-group">
          <div class="card-title">QR Generator</div>
          <div class="card-sub">Create QR codes for links & text.</div>
        </div>
      </div>
      <div class="field">
        <label class="mini">Text or URL</label>
        <input id="qr-text" type="text" placeholder="https://example.com">
      </div>
      <button id="qr-btn" class="btn btn-accent btn-action">Generate</button>
      <div id="qr-container" class="qr-container">
        <div id="qr-loading" class="loading-txt">Generating...</div>
        <img id="qr-image" class="qr-img" alt="QR Code" style="display:none;" />
        <a id="qr-download" class="link-btn" style="display:none; margin-top:10px;">Download</a>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">More Tools</div>
          <div class="card-sub">Specialized calculators.</div>
        </div>
      </div>

      <div class="search-box">
        <div class="search-icon"></div>
        <input type="text" id="tool-search" class="search-input" placeholder="Search (e.g., GST, Fuel, Base)...">
      </div>

      <div class="category-label">Finance</div>
      <div class="chips">
        <button class="chip-btn active" data-panel="loan-panel">Loan / EMI</button>
        <button class="chip-btn" data-panel="gst-panel">GST / VAT</button>
        <button class="chip-btn" data-panel="invest-panel">SIP / Invest</button>
        <button class="chip-btn" data-panel="goal-panel">Goal Planner</button>
        <button class="chip-btn" data-panel="bill-panel">Split Bill</button>
        <button class="chip-btn" data-panel="ci-panel">Compound Int.</button>
      </div>

      <div class="category-label">Health</div>
      <div class="chips">
        <button class="chip-btn" data-panel="health-panel">Health Station (BMI/BMR)</button>
      </div>
      
      <div class="category-label">Travel</div>
      <div class="chips">
        <button class="chip-btn" data-panel="fuel-panel">Fuel Cost</button>
      </div>

      <div class="category-label">Other Tools</div>
      <div class="chips">
        <button class="chip-btn" data-panel="unit-panel">Converters</button>
        <button class="chip-btn" data-panel="time-panel">Day Counter</button>
        <button class="chip-btn" data-panel="text-panel">Text Tools</button>
        <button class="chip-btn" data-panel="base-panel">Base Converter</button>
        <button class="chip-btn" data-panel="gpa-panel">GPA</button>
      </div>

      <div id="fuel-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px">
           <div class="card-title">Fuel Cost Calculator</div>
           <div class="card-sub">Calculate trip cost & fuel required.</div>
        </div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Distance (km)</label><input id="fuel-dist" type="number" placeholder="300"></div>
           <div class="field flex-1"><label class="mini">Mileage (km/l)</label><input id="fuel-mil" type="number" placeholder="15"></div>
        </div>
        <div class="field"><label class="mini">Fuel Price (per liter)</label><input id="fuel-price" type="number" placeholder="100"></div>
        <button id="fuel-btn" class="btn btn-accent btn-action">Calculate Cost</button>
        <div id="fuel-res" class="result-text"></div>
      </div>

      <div id="goal-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px">
           <div class="card-title">Goal Planner</div>
           <div class="card-sub">How much to invest to reach a goal?</div>
        </div>
        <div class="field"><label class="mini">Target Amount</label><input id="goal-target" type="number" placeholder="10000000"></div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Years</label><input id="goal-time" type="number" placeholder="10"></div>
           <div class="field flex-1"><label class="mini">Exp. Rate %</label><input id="goal-rate" type="number" placeholder="12"></div>
        </div>
        <button id="goal-btn" class="btn btn-accent btn-action">Calculate Monthly SIP</button>
        <div id="goal-res" class="result-text"></div>
      </div>

      <div id="text-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px">
           <div class="card-title">Text Analysis</div>
           <div class="card-sub">Word count & transformation.</div>
        </div>
        <div class="field">
           <textarea id="txt-in" rows="4" placeholder="Type or paste text here..."></textarea>
        </div>
        <div class="text-stats" style="margin-bottom:10px;">
           <div class="stat-box"><div id="txt-words" class="stat-val">0</div><div class="stat-lbl">Words</div></div>
           <div class="stat-box"><div id="txt-chars" class="stat-val">0</div><div class="stat-lbl">Characters</div></div>
        </div>
        <div class="row" style="gap:5px;">
           <button id="txt-upper" class="btn small flex-1" style="font-size:0.8rem;">UPPER</button>
           <button id="txt-lower" class="btn small flex-1" style="font-size:0.8rem;">lower</button>
           <button id="txt-clear" class="btn small flex-1" style="font-size:0.8rem;">Clear</button>
        </div>

        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px">
           <div class="card-title">Password Generator</div>
        </div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Length</label><input id="pw-len" type="number" value="12"></div>
           <button id="pw-btn" class="btn btn-accent flex-1" style="margin-top:19px">Generate</button>
        </div>
        <div id="pw-res" class="result-text" style="word-break:break-all;"></div>
      </div>

      <div id="base-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px">
           <div class="card-title">Number Base Converter</div>
           <div class="card-sub">Decimal, Binary & Hexadecimal.</div>
        </div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Number</label><input id="base-num" type="text" placeholder="10"></div>
           <div class="field flex-1"><label class="mini">From Base</label>
             <select id="base-from">
               <option value="10">Decimal (10)</option>
               <option value="2">Binary (1010)</option>
               <option value="16">Hex (A)</option>
             </select>
           </div>
        </div>
        <button id="base-btn" class="btn btn-accent btn-action">Convert</button>
        <div id="base-res" class="result-text"></div>
      </div>

      <div id="health-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px">
           <div class="card-title">Health Station</div>
           <div class="card-sub">BMI, BMR, Water & Protein Analysis.</div>
        </div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Age</label><input id="h-age" type="number" placeholder="25"></div>
           <div class="field flex-1"><label class="mini">Gender</label><select id="h-gender"><option value="male">Male</option><option value="female">Female</option></select></div>
        </div>
        <div class="row">
          <div class="field flex-1"><label class="mini">Weight (kg)</label><input id="h-weight" type="number" placeholder="70"></div>
          <div class="field flex-1"><label class="mini">Height (cm)</label><input id="h-height" type="number" placeholder="170"></div>
        </div>
        <div class="field">
          <label class="mini">Activity Level</label>
          <select id="h-activity">
            <option value="1.2">Sedentary (Little/No exercise)</option>
            <option value="1.375">Light (Exercise 1-3 days/wk)</option>
            <option value="1.55">Moderate (Exercise 3-5 days/wk)</option>
            <option value="1.725">Active (Exercise 6-7 days/wk)</option>
            <option value="1.9">Very Active (Physical job)</option>
          </select>
        </div>
        <button id="h-btn" class="btn btn-accent btn-action">Calculate Stats</button>
        
        <div id="h-result" class="health-stats" style="display:none;">
          <div class="stat-box">
             <div class="info-icon" id="bmi-info">i</div>
             <div id="res-bmi" class="stat-val">--</div><div class="stat-lbl">BMI Score</div>
          </div>
          <div class="stat-box"><div id="res-bmr" class="stat-val">--</div><div class="stat-lbl">BMR (Cal/Day)</div></div>
          <div class="stat-box"><div id="res-water" class="stat-val">--</div><div class="stat-lbl">Water (L)</div></div>
          <div class="stat-box"><div id="res-protein" class="stat-val">--</div><div class="stat-lbl">Protein (g)</div></div>
        </div>
        <div id="h-msg" class="result-text" style="text-align:center;"></div>
      </div>

      <div id="bill-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px"><div class="card-title">Bill Splitter</div><div class="card-sub">Split bills & calculate tips.</div></div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Total Bill</label><input id="bill-amt" type="number" placeholder="2500"></div>
           <div class="field flex-1"><label class="mini">Tip %</label><input id="bill-tip" type="number" placeholder="10"></div>
        </div>
        <div class="field"><label class="mini">Number of People</label><input id="bill-ppl" type="number" placeholder="4"></div>
        <button id="bill-btn" class="btn btn-accent btn-action">Split Bill</button>
        <div id="bill-res" class="result-text"></div>
      </div>

      <div id="ci-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px"><div class="card-title">Compound Interest</div><div class="card-sub">Calculate wealth growth.</div></div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Principal</label><input id="ci-p" type="number" placeholder="10000"></div>
           <div class="field flex-1"><label class="mini">Rate %</label><input id="ci-r" type="number" placeholder="8"></div>
        </div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Years</label><input id="ci-t" type="number" placeholder="10"></div>
           <div class="field flex-1"><label class="mini">Compounded</label><select id="ci-n"><option value="1">Yearly</option><option value="4">Quarterly</option><option value="12">Monthly</option></select></div>
        </div>
        <button id="ci-btn" class="btn btn-accent btn-action">Calculate Amount</button>
        <div id="ci-res" class="result-text"></div>
      </div>

      <div id="loan-panel" class="panel active">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px"><div class="card-title">Loan / EMI</div><div class="card-sub">Monthly payments.</div></div>
        <div class="row">
           <div class="field" style="width:80px"><label class="mini">Currency</label><select id="emi-currency"><option value="₹">₹ INR</option><option value="$">$ USD</option><option value="€">€ EUR</option><option value="£">£ GBP</option><option value="¥">¥ JPY</option></select></div>
           <div class="field flex-1"><label class="mini">Loan Amount</label><input id="emi-principal" type="number" placeholder="100000"></div>
        </div>
        <div class="row">
          <div class="field flex-1"><label class="mini">Rate %</label><input id="emi-rate" type="number" step="0.1" placeholder="7.5"></div>
          <div class="field" style="width:80px"><label class="mini">Tenure</label><input id="emi-time" type="number" placeholder="5"></div>
          <div class="field" style="width:100px"><label class="mini">Period</label><select id="emi-unit"><option value="years">Years</option><option value="months">Months</option></select></div>
        </div>
        <button id="emi-calc" class="btn btn-accent btn-action">Calculate EMI</button>
        <div id="emi-result" class="result-text"></div>
      </div>

      <div id="gst-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px"><div class="card-title">GST / VAT</div><div class="card-sub">Add or Remove Tax.</div></div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Amount</label><input id="gst-amt" type="number" placeholder="1000"></div>
           <div class="field flex-1"><label class="mini">Tax Rate %</label><input id="gst-rate" type="number" placeholder="18"></div>
        </div>
        <div class="row" style="margin-top:15px; gap:10px;">
          <button id="gst-add" class="btn flex-1" style="font-size:0.9rem">Add GST (+)</button>
          <button id="gst-rem" class="btn flex-1" style="font-size:0.9rem">Remove GST (-)</button>
        </div>
        <div id="gst-res" class="result-text"></div>
      </div>

      <div id="unit-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px"><div class="card-title">Unit Converter</div><div class="card-sub">Length, weight, temp & speed.</div></div>
        <div class="field"><label class="mini">Type</label><select id="u-type"><option value="length">Length</option><option value="weight">Weight</option><option value="temp">Temperature</option><option value="speed">Speed</option></select></div>
        <div class="row">
          <div class="field flex-1"><label class="mini">From</label><select id="u-from"></select></div>
          <button id="u-swap" class="btn small" style="width:40px; margin-top: 18px">⇄</button>
          <div class="field flex-1"><label class="mini">To</label><select id="u-to"></select></div>
        </div>
        <div class="field"><label class="mini">Value</label><input id="u-val" type="number" placeholder="1"></div>
        <button id="u-btn" class="btn btn-accent btn-action">Convert</button>
        <div id="u-res" class="result-text"></div>
      </div>

      <div id="invest-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px"><div class="card-title">SIP Calculator</div><div class="card-sub">Estimate returns.</div></div>
        <div class="row">
           <div class="field" style="width:80px"><label class="mini">Currency</label><select id="sip-currency"><option value="₹">₹ INR</option><option value="$">$ USD</option><option value="€">€ EUR</option><option value="£">£ GBP</option><option value="¥">¥ JPY</option></select></div>
          <div class="field flex-1"><label class="mini">Monthly</label><input id="sip-amt" type="number" placeholder="5000"></div>
        </div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Rate %</label><input id="sip-rate" type="number" placeholder="12"></div>
           <div class="field flex-1"><label class="mini">Years</label><input id="sip-years" type="number" placeholder="10"></div>
        </div>
        <button id="sip-btn" class="btn btn-accent btn-action">Calculate Return</button>
        <div id="sip-res" class="result-text"></div>
      </div>
      
      <div id="time-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px"><div class="card-title">Day Counter</div><div class="card-sub">Count days between dates.</div></div>
        <div class="row">
           <div class="field flex-1"><label class="mini">Start</label><input id="time-start" type="date"></div>
           <div class="field flex-1"><label class="mini">End</label><input id="time-end" type="date"></div>
        </div>
        <button id="time-diff" class="btn btn-accent btn-action">Calculate Days</button>
        <div id="time-result" class="result-text"></div>
      </div>

      <div id="gpa-panel" class="panel">
        <div class="divider"></div>
        <div class="title-group" style="margin-bottom:10px"><div class="card-title">GPA / Average</div><div class="card-sub">Simple Mean.</div></div>
        <div class="field"><label class="mini">Numbers (comma separated)</label><input id="gpa-in" type="text" placeholder="8.5, 9.0, 7.5"></div>
        <button id="gpa-btn" class="btn btn-accent btn-action">Calculate Average</button>
        <div id="gpa-res" class="result-text"></div>
      </div>

    </section>
  </main>

  <footer>
    Made With <span class="heart">❤️</span> By Avinash Gupta!
  </footer>
</div>
<script>
  const $ = id => document.getElementById(id);
  const formatNum = (num) => parseFloat(num.toFixed(4));
  
  /* --- 1. SEARCH BAR LOGIC --- */
  $('tool-search').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const chips = document.querySelectorAll('.chip-btn');
    
    chips.forEach(chip => {
      const label = chip.textContent.toLowerCase();
      if(label.includes(term) || chip.dataset.panel.includes(term)) {
        chip.classList.remove('hidden');
      } else {
        chip.classList.add('hidden');
      }
    });
    
    document.querySelectorAll('.category-label').forEach(lbl => {
      const nextChips = lbl.nextElementSibling;
      const visible = nextChips.querySelectorAll('.chip-btn:not(.hidden)').length > 0;
      lbl.style.display = visible ? 'block' : 'none';
    });
  });

  /* --- 2. CALCULATOR LOGIC & SMART HISTORY --- */
  let expr = ''; 
  let useDeg = true; 
  let history = []; 

  const updateHistory = (expression, result) => {
    history.push(`${expression} = ${result}`);
    if(history.length > 3) history.shift(); 
    
    const tape = $('calc-history');
    tape.innerHTML = history.map(h => `<div class="hist-item">${h}</div>`).join('');
    tape.classList.add('show');
    $('hist-lbl').style.display = 'block'; 
    tape.scrollTop = tape.scrollHeight;
    
    tape.querySelectorAll('.hist-item').forEach(item => {
      item.onclick = () => {
        const val = item.textContent.split('=')[1].trim();
        expr += val;
        upd();
      };
    });
  };

  window.sin = (x) => Math.sin(useDeg ? x * Math.PI/180 : x);
  window.cos = (x) => Math.cos(useDeg ? x * Math.PI/180 : x);
  window.tan = (x) => Math.tan(useDeg ? x * Math.PI/180 : x);
  window.log = (x) => Math.log10(x);
  window.ln = (x) => Math.log(x);

  const upd = () => $('calc-expression').textContent = expr;
  
  const k = ['7','8','9','÷','4','5','6','×','1','2','3','−','0','.','%','+'];
  k.forEach(x => { 
    let b=document.createElement('button'); b.className='btn'; b.textContent=x; 
    b.onclick=()=>{expr+={'÷':'/','×':'*','−':'-'}[x]||x; upd();}; 
    $('calc-grid').appendChild(b); 
  });

  $('calc-equals').onclick = () => { 
    try { 
      if(!expr) return;
      let s = expr.replace(/×/g,'*').replace(/÷/g,'/').replace(/−/g,'-').replace(/π/g, Math.PI).replace(/√\(/g, 'Math.sqrt(').replace(/\^/g, '**');
      const res = formatNum(eval(s));
      updateHistory(expr, res);
      $('calc-result').textContent = res; 
      expr = String(res); 
    } catch { $('calc-result').textContent="Err"; } 
  };
  
  $('calc-clear').onclick = () => { 
    if(expr === '' && $('calc-result').textContent === '0') {
        history = [];
        $('calc-history').innerHTML = '';
        $('hist-lbl').style.display = 'none';
    } else {
        expr=''; upd(); $('calc-result').textContent='0'; 
    }
  };

  $('calc-back').onclick = () => { expr=expr.slice(0,-1); upd(); };
  
  $('calc-copy').onclick = () => {
    const res = $('calc-result').textContent;
    navigator.clipboard.writeText(res).then(() => {
      const b = $('calc-copy'); const old = b.textContent;
      b.textContent = "Copied!"; b.style.color="var(--accent)";
      setTimeout(() => { b.textContent = old; b.style.color=""; }, 1500);
    });
  };

  $('sc-switch').onclick = function(){ this.classList.toggle('on'); $('sci-keys').style.display = this.classList.contains('on')?'grid':'none'; };
  
  document.querySelectorAll('#sci-keys .btn:not(#deg-toggle)').forEach(b => {
    b.onclick = () => {
      const fn = b.dataset.fn;
      if(fn === 'pi') expr += 'π'; else if(fn === 'pow') expr += '**'; else if(fn === 'sqrt') expr += '√('; else expr += `${fn}(`;
      upd();
    }
  });

  const degBtn = $('deg-toggle');
  degBtn.onclick = () => { 
    useDeg = !useDeg; 
    degBtn.textContent = useDeg ? "DEG" : "RAD"; 
    degBtn.classList.toggle('active-mode', useDeg); 
  };
  degBtn.classList.add('active-mode');

  /* --- 3. HEALTH STATION --- */
  $('h-btn').onclick = () => {
    const age = parseFloat($('h-age').value);
    const gender = $('h-gender').value;
    const w = parseFloat($('h-weight').value);
    const h = parseFloat($('h-height').value);
    const act = parseFloat($('h-activity').value);
    
    if(!age || !w || !h) { $('h-msg').textContent = "Please fill all fields"; return; }
    
    // BMI
    const bmi = (w / ((h/100)*(h/100))).toFixed(1);
    
    // BMR
    let bmr = (10 * w) + (6.25 * h) - (5 * age);
    bmr = (gender === 'male' ? bmr + 5 : bmr - 161);
    const tdee = Math.round(bmr * act);
    
    // Water & Protein
    const water = (w / 30).toFixed(1);
    const pFactor = 0.8 + (act - 1.2); 
    const protein = Math.round(w * pFactor);

    $('h-result').style.display = 'grid';
    $('res-bmi').textContent = bmi;
    $('res-bmr').textContent = tdee;
    $('res-water').textContent = water;
    $('res-protein').textContent = protein;
    
    let msg = bmi < 18.5 ? "Underweight" : bmi < 25 ? "Healthy Weight" : bmi < 30 ? "Overweight" : "Obese";
    $('h-msg').textContent = `Status: ${msg}`;
  };

  $('bmi-info').onclick = (e) => {
      e.stopPropagation();
      alert("BMI Categories (WHO):\n\n• Below 18.5: Underweight\n• 18.5 - 24.9: Normal\n• 25.0 - 29.9: Overweight\n• 30.0+: Obese");
  };

  /* --- 4. NEW TOOLS (v1.6) --- */
  
  // Fuel Cost
  $('fuel-btn').onclick = () => {
    const d = parseFloat($('fuel-dist').value);
    const m = parseFloat($('fuel-mil').value);
    const p = parseFloat($('fuel-price').value);
    if(!d || !m || !p) return;
    const fuelNeeded = d / m;
    const cost = fuelNeeded * p;
    $('fuel-res').innerHTML = `Fuel Needed: ${formatNum(fuelNeeded)} L<br><span style="font-size:1.1rem; font-weight:600; color:var(--accent)">Total Cost: ₹${Math.round(cost)}</span>`;
  };

  // Goal Planner (Reverse SIP)
  $('goal-btn').onclick = () => {
    const target = parseFloat($('goal-target').value);
    const t = parseFloat($('goal-time').value); // Years
    const r = parseFloat($('goal-rate').value); // Yearly %
    
    if(!target || !t || !r) return;
    
    const i = r / 1200; // Monthly Rate
    const n = t * 12;   // Months
    
    // SIP Formula: FV = P * [ (1+i)^n - 1 ] / i * (1+i)
    // Reverse: P = FV / ( [ (1+i)^n - 1 ] / i * (1+i) )
    
    const factor = ( (Math.pow(1+i, n) - 1) / i ) * (1+i);
    const monthly = target / factor;
    
    $('goal-res').innerHTML = `To reach goal in ${t} years:<br><span style="font-size:1.1rem; font-weight:600; color:var(--accent)">Invest ₹${Math.round(monthly)} / month</span>`;
  };

  // Text Tools
  const updateTextStats = () => {
    const txt = $('txt-in').value;
    $('txt-chars').textContent = txt.length;
    // Split by whitespace and filter empty strings
    const words = txt.trim().split(/\s+/).filter(w => w.length > 0).length;
    $('txt-words').textContent = words;
  };
  $('txt-in').addEventListener('input', updateTextStats);
  
  $('txt-upper').onclick = () => { $('txt-in').value = $('txt-in').value.toUpperCase(); updateTextStats(); };
  $('txt-lower').onclick = () => { $('txt-in').value = $('txt-in').value.toLowerCase(); updateTextStats(); };
  $('txt-clear').onclick = () => { $('txt-in').value = ''; updateTextStats(); };

  // Base Converter
  $('base-btn').onclick = () => {
    const num = $('base-num').value;
    const from = parseInt($('base-from').value);
    if(!num) return;
    
    try {
      const dec = parseInt(num, from);
      if(isNaN(dec)) throw new Error();
      
      const bin = dec.toString(2);
      const oct = dec.toString(8); // Optional
      const hex = dec.toString(16).toUpperCase();
      const decVal = dec.toString(10);
      
      $('base-res').innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span>DEC:</span> <b>${decVal}</b></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span>BIN:</span> <b>${bin}</b></div>
        <div style="display:flex; justify-content:space-between;"><span>HEX:</span> <b>${hex}</b></div>
      `;
    } catch {
      $('base-res').textContent = "Invalid Number for Base";
    }
  };

  /* --- 5. TOP & EXISTING TOOLS --- */
  $('age-btn').onclick = () => {
    const dVal=$('dob-input').value; if(!dVal)return;
    const d=new Date(dVal), t=new Date(); let y=t.getFullYear()-d.getFullYear(), m=t.getMonth()-d.getMonth(), days=t.getDate()-d.getDate();
    if(days<0){ m--; days+=new Date(t.getFullYear(),t.getMonth(),0).getDate(); } if(m<0){ y--; m+=12; }
    $('age-result').textContent = `${y} Years, ${m} Months, ${days} Days`;
  };

  $('cur-btn').onclick = async () => {
    const a=$('cur-amt').value||1, f=$('cur-from').value, t=$('cur-to').value;
    $('cur-res').textContent="Loading..."; $('cur-source').style.display='none';
    try{ 
        const r=await fetch(`https://api.frankfurter.app/latest?amount=${a}&from=${f}&to=${t}`); 
        const d=await r.json();
        $('cur-res').textContent=`${a} ${f} = ${d.rates[t]} ${t}`; 
        $('cur-date').textContent = `Updated: ${d.date}`; 
        $('cur-source').style.display='block'; 
    }catch{ $('cur-res').textContent="Err"; }
  };
  $('cur-swap').onclick = () => {
     const f=$('cur-from'), t=$('cur-to'), tmp=f.value; f.value=t.value; t.value=tmp;
     f.dispatchEvent(new Event('change')); t.dispatchEvent(new Event('change'));
  }

  $('qr-btn').onclick = () => {
    const txt = $('qr-text').value; if(!txt) return;
    $('qr-container').classList.add('show'); $('qr-image').style.display='none'; $('qr-loading').style.display='block';
    const url = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(txt)}`;
    $('qr-image').onload = () => { $('qr-loading').style.display='none'; $('qr-image').style.display='block'; fetch(url).then(r=>r.blob()).then(b=>{$('qr-download').href=URL.createObjectURL(b); $('qr-download').download="qr.png"; $('qr-download').style.display="inline-block";});};
    $('qr-image').src = url;
  }

  // Converters (Ghost Dropdown Fix)
  const uData = {
    length: { opts: ['m','cm','ft','in'], fn: (v,f,t) => {
      let m = v; if(f==='cm') m=v/100; if(f==='ft') m=v/3.2808; if(f==='in') m=v/39.37;
      if(t==='m') return m; if(t==='cm') return m*100; if(t==='ft') return m*3.2808; if(t==='in') return m*39.37;
    }},
    weight: { opts: ['kg','lb'], fn: (v,f,t) => f===t?v : (f==='kg'?v*2.2046:v/2.2046) },
    temp: { opts: ['C','F'], fn: (v,f,t) => f===t?v : (f==='C'?v*1.8+32 : (v-32)/1.8) },
    speed: { opts: ['kmph','mph'], fn: (v,f,t) => f===t?v : (f==='kmph'?v*0.6213:v/0.6213) }
  };

  function renderUnits(){
    const type = $('u-type').value; const data = uData[type];
    const fS = $('u-from'); const tS = $('u-to');
    
    fS.innerHTML = ''; tS.innerHTML = '';
    
    [fS, tS].forEach(el => {
        el.removeAttribute('data-customized');
        el.style.display = 'block'; 
        if(el.nextElementSibling && el.nextElementSibling.classList.contains('custom-dropdown')) {
            el.nextElementSibling.remove();
        }
    });

    data.opts.forEach(o => { fS.add(new Option(o,o)); tS.add(new Option(o,o)); });
    if(tS.options.length > 1) tS.selectedIndex = 1;

    initCustomDropdowns($('unit-panel'));
  }
  $('u-type').onchange = renderUnits;
  
  $('u-btn').onclick = () => {
    const v = parseFloat($('u-val').value); if(isNaN(v)) return;
    const res = uData[$('u-type').value].fn(v, $('u-from').value, $('u-to').value);
    $('u-res').textContent = `${formatNum(res)} ${$('u-to').value}`;
  }
  $('u-swap').onclick = () => {
     const f=$('u-from'), t=$('u-to'), tmp=f.value; f.value=t.value; t.value=tmp;
     f.dispatchEvent(new Event('change')); t.dispatchEvent(new Event('change'));
     if($('u-val').value) $('u-btn').click();
  }

  $('bill-btn').onclick = () => {
    const amt = parseFloat($('bill-amt').value);
    const tip = parseFloat($('bill-tip').value) || 0;
    const ppl = parseFloat($('bill-ppl').value) || 1;
    if(!amt) return;
    const totalTip = (amt * tip) / 100;
    const total = amt + totalTip;
    const perPerson = total / ppl;
    $('bill-res').innerHTML = `Tip: ${formatNum(totalTip)} | Total: ${formatNum(total)}<br><span style="font-size:1.1rem; font-weight:600; color:var(--accent)">Per Person: ${formatNum(perPerson)}</span>`;
  };

  $('ci-btn').onclick = () => {
    const p = parseFloat($('ci-p').value);
    const r = parseFloat($('ci-r').value)/100;
    const t = parseFloat($('ci-t').value);
    const n = parseFloat($('ci-n').value);
    if(!p || !r || !t) return;
    const amount = p * Math.pow((1 + r/n), (n*t));
    const interest = amount - p;
    $('ci-res').innerHTML = `Invested: ${Math.round(p)} | Interest: <span style="color:#22c55e">+${Math.round(interest)}</span><br><span style="font-size:1.1rem; font-weight:600">Total: ${Math.round(amount)}</span>`;
  };

  $('emi-calc').onclick = () => {
    const cur = $('emi-currency').value;
    const p = parseFloat($('emi-principal').value);
    const r = parseFloat($('emi-rate').value)/1200;
    const timeVal = parseFloat($('emi-time').value);
    const timeUnit = $('emi-unit').value;
    if(!p || !timeVal) return;
    const n = timeUnit === 'years' ? timeVal * 12 : timeVal;
    const emi = (p*r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1);
    const totalPay = emi * n;
    $('emi-result').textContent = `EMI: ${cur}${Math.round(emi)}\nInterest: ${cur}${Math.round(totalPay-p)}\nTotal: ${cur}${Math.round(totalPay)}`;
    $('emi-result').style.whiteSpace = 'pre-wrap';
  };
  
  const calcGST = (mode) => {
    const amt = parseFloat($('gst-amt').value); const rate = parseFloat($('gst-rate').value);
    if(isNaN(amt)||isNaN(rate)) return;
    let net, gst, total;
    if(mode==='add'){ gst=(amt*rate)/100; total=amt+gst; net=amt; }
    else{ net=(amt*100)/(100+rate); gst=amt-net; total=amt; }
    $('gst-res').innerHTML=`Net: ${formatNum(net)} | GST: ${formatNum(gst)} | <b style="color:var(--accent)">Total: ${formatNum(total)}</b>`;
  };
  $('gst-add').onclick=()=>calcGST('add'); $('gst-rem').onclick=()=>calcGST('remove');

  $('sip-btn').onclick = () => {
     const cur = $('sip-currency').value;
     const p = $('sip-amt').value, i = $('sip-rate').value/1200, n = $('sip-years').value*12;
     const val = p * ((Math.pow(1+i, n) - 1) / i) * (1 + i);
     $('sip-res').textContent = `Total Value: ${cur}${Math.round(val)}`;
  }

  $('time-diff').onclick = () => { const d1=new Date($('time-start').value), d2=new Date($('time-end').value); $('time-result').textContent = Math.ceil(Math.abs(d2-d1)/(8.64e7)) + " days"; };
  $('pw-btn').onclick = () => { const c="A-Za-z0-9!@#$"; let o=""; for(let i=0;i<$('pw-len').value;i++)o+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%".charAt(Math.floor(Math.random()*67)); $('pw-res').textContent=o; };
  $('gpa-btn').onclick = () => { const n=$('gpa-in').value.split(',').map(Number).filter(x=>!isNaN(x)); $('gpa-res').textContent="Avg: "+(n.length?(n.reduce((a,b)=>a+b,0)/n.length).toFixed(2):0); };

  /* --- SYSTEM FUNCTIONS --- */
  function initCustomDropdowns(scope = document) {
    scope.querySelectorAll('select:not([data-customized])').forEach(select => {
      select.setAttribute('data-customized', 'true');
      const wrapper = document.createElement('div'); wrapper.className = 'custom-dropdown';
      const trigger = document.createElement('div'); trigger.className = 'dropdown-trigger';
      trigger.textContent = select.options[select.selectedIndex]?.text || '';
      select.addEventListener('change', () => { trigger.textContent = select.options[select.selectedIndex]?.text || ''; });
      
      const menu = document.createElement('div'); menu.className = 'dropdown-menu';
      Array.from(select.options).forEach(opt => {
        const item = document.createElement('div'); item.className = 'dropdown-item';
        if(opt.selected) item.classList.add('selected');
        item.textContent = opt.text;
        item.onclick = (e) => {
          e.stopPropagation();
          wrapper.classList.remove('active');
          menu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
          select.value = opt.value;
          select.dispatchEvent(new Event('change'));
        };
        menu.appendChild(item);
      });
      trigger.onclick = (e) => {
        e.stopPropagation();
        document.querySelectorAll('.custom-dropdown').forEach(d => { if(d !== wrapper) d.classList.remove('active'); });
        wrapper.classList.toggle('active');
      };
      wrapper.appendChild(trigger); wrapper.appendChild(menu);
      select.parentNode.insertBefore(wrapper, select.nextSibling);
    });
  }
  document.addEventListener('click', () => { document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active')); });

  function updateThemeColors(themeName) {
    const root = document.documentElement; const isLight = document.body.dataset.theme === 'light';
    let accent, accentText;
    if (themeName !== 'mono') {
        if(themeName === 'orange') { accent = '#f97316'; accentText = '#000000'; }
        else if(themeName === 'blue') { accent = '#3b82f6'; accentText = '#ffffff'; }
        else if(themeName === 'green') { accent = '#22c55e'; accentText = '#000000'; }
        else if(themeName === 'purple') { accent = '#a855f7'; accentText = '#ffffff'; }
    } else { accent = isLight ? '#000000' : '#ffffff'; accentText = isLight ? '#ffffff' : '#000000'; }
    root.style.setProperty('--accent', accent); root.style.setProperty('--accent-text', accentText);
  }
  $('toggle-theme').onclick = () => { document.body.dataset.theme = document.body.dataset.theme === 'light' ? 'dark' : 'light'; updateThemeColors($('theme-color').value); };
  $('theme-color').onchange = (e) => updateThemeColors(e.target.value);
  
  document.querySelectorAll('.chip-btn').forEach(b => b.onclick = () => {
     document.querySelectorAll('.chip-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
     document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); $(b.dataset.panel).classList.add('active');
  });

  // Init
  updateThemeColors('mono'); initCustomDropdowns(); renderUnits();
</script>
</body>
</html>
